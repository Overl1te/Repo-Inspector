const I18N = {
  en: {
    pageTitle: "Repo Inspector - Generator",
    kicker: "EMBEDDABLE STATS",
    title: "SVG/JSON generator",
    subtitle: "Build URL parameters visually, preview card, and copy URL/Markdown.",
    back: "Back to reports",
    config: "Configuration",
    importLabel: "Import by GitHub URL / API URL / Markdown",
    importPlaceholder: "https://github.com/owner/repo or ![Card](https://.../api?...)",
    importBtn: "Import",
    owner: "Owner",
    repo: "Repository",
    cardType: "Card type",
    cardRepo: "Repository stats",
    cardQuality: "Quality stats",
    format: "Format",
    theme: "Theme",
    locale: "Locale",
    customTitle: "Custom title",
    optionalTitle: "Optional title",
    hide: "Hide flags",
    hideNone: "None",
    hideSelectAll: "Select all",
    hideClear: "Clear",
    hide_description: "Description",
    hide_languages: "Languages",
    hide_meta: "Meta chips",
    hide_stars: "Stars metric",
    hide_forks: "Forks metric",
    hide_issues: "Issues metric",
    hide_watchers: "Watchers metric",
    hide_status: "Status counters",
    hide_lines: "Code metrics",
    hide_stacks: "Stacks row",
    hide_commit: "Commit row",
    hide_categories: "Categories bars",
    hide_ring: "Score ring panel",
    hide_footer: "Footer",
    width: "Card width",
    langs: "Languages count (repo card)",
    animate: "Enable animation",
    animation: "Animation mode",
    duration: "Animation duration (ms)",
    cache: "Cache seconds (SVG)",
    includeReport: "Include full report (quality JSON)",
    palettePreset: "Palette preset",
    presetOcean: "Ocean Breeze",
    presetEmber: "Ember",
    presetNeon: "Neon Pulse",
    presetPaper: "Paper",
    presetForest: "Forest Ink",
    applyPreset: "Apply preset",
    randomizePalette: "Randomize",
    resetPalette: "Reset palette",
    randomTheme: "Random theme",
    preview: "Preview",
    copyUrl: "Copy URL",
    copyMd: "Copy Markdown",
    openUrl: "Open URL",
    generatedUrl: "Generated URL",
    markdown: "Markdown embed",
    invalidRepoUrl: "Enter a valid GitHub URL, card API URL, or Markdown embed like ![...](https://.../api?...).",
    copied: "Copied",
    apiMissing: "Set API_BASE in web/config.js to use generator preview on GitHub Pages.",
    failedJson: "Failed to load JSON",
    customThemeTitle: "Custom theme",
    customThemeHint: "Set color palette for SVG card manually.",
    theme_ocean: "Ocean",
    theme_light: "Light",
    theme_midnight: "Midnight",
    theme_nord: "Nord",
    theme_forest: "Forest",
    theme_sunset: "Sunset",
    theme_lavender: "Lavender",
    theme_graphite: "Graphite",
    theme_mint: "Mint",
    theme_amber: "Amber",
    theme_rose: "Rose",
    theme_slate: "Slate",
    theme_sand: "Sand",
    theme_aurora: "Aurora",
    theme_matrix: "Matrix",
    theme_mono: "Mono",
    theme_volcano: "Volcano",
    theme_arctic: "Arctic",
    theme_noir: "Noir",
    theme_sakura: "Sakura",
    theme_custom: "Custom",
    color_bg_start: "Background start",
    color_bg_end: "Background end",
    color_border: "Border",
    color_panel: "Panel",
    color_overlay: "Overlay",
    color_chip_bg: "Chip bg",
    color_chip_text: "Chip text",
    color_text: "Text",
    color_muted: "Muted text",
    color_accent: "Accent",
    color_accent_2: "Accent 2",
    color_accent_soft: "Accent soft",
    color_track: "Track",
    color_pass: "Pass",
    color_warn: "Warn",
    color_fail: "Fail",
  },
  ru: {
    pageTitle: "Repo Inspector - Генератор",
    kicker: "ВСТРАИВАЕМАЯ СТАТИСТИКА",
    title: "SVG/JSON генератор",
    subtitle: "Собирайте URL-параметры визуально, смотрите превью и копируйте URL/Markdown.",
    back: "Назад к отчетам",
    config: "Конфигурация",
    importLabel: "Импорт из GitHub / API URL / Markdown",
    importPlaceholder: "https://github.com/owner/repo или ![Card](https://.../api?...)",
    importBtn: "Импорт",
    owner: "Владелец",
    repo: "Репозиторий",
    cardType: "Тип карточки",
    cardRepo: "Статистика репозитория",
    cardQuality: "Статистика quality",
    format: "Формат",
    theme: "Тема",
    locale: "Язык",
    customTitle: "Свой заголовок",
    optionalTitle: "Необязательно",
    hide: "Скрыть блоки",
    hideNone: "Ничего",
    hideSelectAll: "Выбрать все",
    hideClear: "Очистить",
    hide_description: "Описание",
    hide_languages: "Языки",
    hide_meta: "Мета-чипы",
    hide_stars: "Метрика звезд",
    hide_forks: "Метрика форков",
    hide_issues: "Метрика issues",
    hide_watchers: "Метрика watchers",
    hide_status: "Счетчики статусов",
    hide_lines: "Метрики кода",
    hide_stacks: "Строка стеков",
    hide_commit: "Строка коммита",
    hide_categories: "Бары категорий",
    hide_ring: "Панель кольца оценки",
    hide_footer: "Футер",
    width: "Ширина карточки",
    langs: "Кол-во языков (repo карточка)",
    animate: "Включить анимацию",
    animation: "Режим анимации",
    duration: "Длительность анимации (мс)",
    cache: "Кэш (сек, SVG)",
    includeReport: "Добавить полный отчет (quality JSON)",
    palettePreset: "Пресет палитры",
    presetOcean: "Морской бриз",
    presetEmber: "Угли",
    presetNeon: "Неон",
    presetPaper: "Бумага",
    presetForest: "Лесные чернила",
    applyPreset: "Применить пресет",
    randomizePalette: "Случайные цвета",
    resetPalette: "Сброс палитры",
    randomTheme: "Случайная тема",
    preview: "Превью",
    copyUrl: "Копировать URL",
    copyMd: "Копировать Markdown",
    openUrl: "Открыть URL",
    generatedUrl: "Сгенерированный URL",
    markdown: "Markdown для встраивания",
    invalidRepoUrl: "Введите корректную ссылку GitHub, URL карточки API или Markdown-вставку вида ![...](https://.../api?...).",
    copied: "Скопировано",
    apiMissing: "Укажите API_BASE в web/config.js для preview на GitHub Pages.",
    failedJson: "Не удалось загрузить JSON",
    customThemeTitle: "Кастомная тема",
    customThemeHint: "Вручную задайте цвета для SVG-карточки.",
    theme_ocean: "Океан",
    theme_light: "День",
    theme_midnight: "Ночь",
    theme_nord: "Норд",
    theme_forest: "Лес",
    theme_sunset: "Закат",
    theme_lavender: "Лаванда",
    theme_graphite: "Графит",
    theme_mint: "Мята",
    theme_amber: "Янтарь",
    theme_rose: "Роза",
    theme_slate: "Сланец",
    theme_sand: "Песок",
    theme_aurora: "Аврора",
    theme_matrix: "Матрица",
    theme_mono: "Моно",
    theme_volcano: "Вулкан",
    theme_arctic: "Арктика",
    theme_noir: "Нуар",
    theme_sakura: "Сакура",
    theme_custom: "Своя",
    color_bg_start: "Фон старт",
    color_bg_end: "Фон конец",
    color_border: "Граница",
    color_panel: "Панель",
    color_overlay: "Overlay",
    color_chip_bg: "Фон чипа",
    color_chip_text: "Текст чипа",
    color_text: "Текст",
    color_muted: "Вторичный текст",
    color_accent: "Акцент",
    color_accent_2: "Акцент 2",
    color_accent_soft: "Мягкий акцент",
    color_track: "Трек",
    color_pass: "PASS",
    color_warn: "WARN",
    color_fail: "FAIL",
  },
};

const THEME_IDS = [
  "ocean",
  "light",
  "midnight",
  "nord",
  "forest",
  "sunset",
  "lavender",
  "graphite",
  "mint",
  "amber",
  "rose",
  "slate",
  "sand",
  "aurora",
  "matrix",
  "mono",
  "volcano",
  "arctic",
  "noir",
  "sakura",
  "custom",
];

const CUSTOM_THEME_KEYS = [
  "bg_start",
  "bg_end",
  "border",
  "panel",
  "overlay",
  "chip_bg",
  "chip_text",
  "text",
  "muted",
  "accent",
  "accent_2",
  "accent_soft",
  "track",
  "pass",
  "warn",
  "fail",
];

const THEME_PRESETS = {
  ocean: {
    bg_start: "#F8FBFF",
    bg_end: "#EEF5FF",
    border: "#A8CBFF",
    panel: "#FFFFFF",
    overlay: "#EDF4FF",
    chip_bg: "#E7F0FF",
    chip_text: "#2D4E83",
    text: "#14284B",
    muted: "#3F6191",
    accent: "#16A4E0",
    accent_2: "#1AB9A2",
    accent_soft: "#B8DBFF",
    track: "#D3E3FB",
    pass: "#0F7F39",
    warn: "#B55A0C",
    fail: "#BE1D2D",
  },
  ember: {
    bg_start: "#2E120C",
    bg_end: "#431A12",
    border: "#8C3E2A",
    panel: "#35160F",
    overlay: "#2C130D",
    chip_bg: "#4C2117",
    chip_text: "#FFD6B7",
    text: "#FFEDE1",
    muted: "#E5B79A",
    accent: "#FF6A3D",
    accent_2: "#FFB347",
    accent_soft: "#6B2A1D",
    track: "#6A2F22",
    pass: "#58D68D",
    warn: "#FFC14A",
    fail: "#FF6E6E",
  },
  neon: {
    bg_start: "#090B1B",
    bg_end: "#140F2B",
    border: "#3D2E73",
    panel: "#130F28",
    overlay: "#1B1537",
    chip_bg: "#231B47",
    chip_text: "#CFFBFF",
    text: "#F4F6FF",
    muted: "#B5B9E0",
    accent: "#28F0E2",
    accent_2: "#FF4FD8",
    accent_soft: "#2E2A60",
    track: "#37346B",
    pass: "#55F08A",
    warn: "#FFD65A",
    fail: "#FF6B9A",
  },
  paper: {
    bg_start: "#FFFDF8",
    bg_end: "#F4EFE2",
    border: "#D8CCB1",
    panel: "#FFF9EE",
    overlay: "#F2EBDC",
    chip_bg: "#EADFC8",
    chip_text: "#5A4631",
    text: "#2F2518",
    muted: "#6F5D49",
    accent: "#8B5E34",
    accent_2: "#B08952",
    accent_soft: "#D8C3A3",
    track: "#D9CFBC",
    pass: "#2E7D32",
    warn: "#B26A00",
    fail: "#B64033",
  },
  forest: {
    bg_start: "#0F2018",
    bg_end: "#183129",
    border: "#2D5E4F",
    panel: "#153027",
    overlay: "#11251D",
    chip_bg: "#1E4236",
    chip_text: "#CFEFDF",
    text: "#EDFDF4",
    muted: "#A4C7B8",
    accent: "#3ECF8E",
    accent_2: "#80E3C1",
    accent_soft: "#255145",
    track: "#2C5044",
    pass: "#54D98C",
    warn: "#E3B84F",
    fail: "#F07F7F",
  },
};

const SVG_ONLY_CONTROL_IDS = [
  "gen-theme",
  "gen-title",
  "gen-hide",
  "gen-width",
  "gen-animate",
  "gen-animation",
  "gen-duration",
  "gen-cache-seconds",
];

const HEX_COLOR_RE = /^#(?:[0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/;
const REPO_RE = /^https?:\/\/github\.com\/([^/\s]+)\/([^/\s#]+?)(?:\.git)?\/?$/;
let lang = "en";
let defaultPalette = null;

const langQuery = new URLSearchParams(window.location.search).get("lang");
if (langQuery === "ru" || langQuery === "en") {
  lang = langQuery;
}

const refs = {
  body: document.body,
  langSwitch: document.getElementById("gen-lang-switch"),
  repoUrl: document.getElementById("gen-repo-url"),
  importBtn: document.getElementById("gen-import-repo"),
  importError: document.getElementById("gen-import-error"),
  owner: document.getElementById("gen-owner"),
  repo: document.getElementById("gen-repo"),
  kind: document.getElementById("gen-kind"),
  format: document.getElementById("gen-format"),
  theme: document.getElementById("gen-theme"),
  locale: document.getElementById("gen-locale"),
  title: document.getElementById("gen-title"),
  hide: document.getElementById("gen-hide"),
  width: document.getElementById("gen-width"),
  langs: document.getElementById("gen-langs"),
  animate: document.getElementById("gen-animate"),
  animation: document.getElementById("gen-animation"),
  duration: document.getElementById("gen-duration"),
  cacheSeconds: document.getElementById("gen-cache-seconds"),
  includeReport: document.getElementById("gen-include-report"),
  themePreset: document.getElementById("gen-theme-preset"),
  themeRandom: document.getElementById("gen-theme-random"),
  applyPreset: document.getElementById("gen-apply-preset"),
  randomizePalette: document.getElementById("gen-randomize-palette"),
  resetPalette: document.getElementById("gen-reset-palette"),
  hideSelectAll: document.getElementById("gen-hide-select-all"),
  hideClear: document.getElementById("gen-hide-clear"),
  svgControls: document.getElementById("gen-svg-only-controls"),
  repoLangsGroup: document.getElementById("gen-repo-langs-group"),
  qualityJsonControls: document.getElementById("gen-quality-json-controls"),
  hidePanel: document.getElementById("gen-hide-panel"),
  hideSummary: document.getElementById("gen-hide-summary-text"),
  copyUrl: document.getElementById("gen-copy-url"),
  copyMd: document.getElementById("gen-copy-md"),
  openUrl: document.getElementById("gen-open-url"),
  url: document.getElementById("gen-url"),
  md: document.getElementById("gen-md"),
  imgWrap: document.getElementById("gen-svg-wrap"),
  img: document.getElementById("gen-preview-image"),
  json: document.getElementById("gen-preview-json"),
  apiWarning: document.getElementById("gen-api-warning"),
  customPanel: document.getElementById("gen-custom-theme-panel"),
};

function t(key) {
  return (I18N[lang] && I18N[lang][key]) || I18N.en[key] || key;
}

function themeLabel(themeId) {
  return t(`theme_${themeId}`);
}

function normalizeApiBase(raw) {
  const value = String(raw || "").trim();
  if (!value) return "";
  return value.replace(/\/$/, "");
}

function getApiBase() {
  const cfg = window.REPO_INSPECTOR_CONFIG || {};
  const byConfig = normalizeApiBase(cfg.API_BASE);
  if (byConfig) return byConfig;
  const byQuery = normalizeApiBase(new URLSearchParams(window.location.search).get("api_base"));
  if (byQuery) return byQuery;
  return "";
}

const API_BASE = getApiBase();

function normalizeHexColor(value) {
  const raw = String(value || "").trim();
  if (!HEX_COLOR_RE.test(raw)) return null;
  if (raw.length === 4) {
    return `#${raw[1]}${raw[1]}${raw[2]}${raw[2]}${raw[3]}${raw[3]}`.toUpperCase();
  }
  return raw.toUpperCase();
}

function clampNumber(value, min, max, fallback) {
  const number = Number(value);
  if (!Number.isFinite(number)) return fallback;
  return Math.max(min, Math.min(max, number));
}

function parseBooleanValue(value, fallback = false) {
  if (value == null) return fallback;
  const normalized = String(value).trim().toLowerCase();
  if (["1", "true", "yes", "on"].includes(normalized)) return true;
  if (["0", "false", "no", "off"].includes(normalized)) return false;
  return fallback;
}

function extractImportUrl(value) {
  const input = String(value || "").trim();
  if (!input) return "";
  const mdAngle = input.match(/!\[[^\]]*]\(\s*<([^>]+)>\s*\)/);
  if (mdAngle && mdAngle[1]) return mdAngle[1].trim();
  const mdPlain = input.match(/!\[[^\]]*]\(\s*([^\s)]+)(?:\s+["'][^"']*["'])?\s*\)/);
  if (mdPlain && mdPlain[1]) return mdPlain[1].trim();
  return input.replace(/^<|>$/g, "").trim();
}

function parseApiImport(value) {
  const input = extractImportUrl(value);
  if (!input) return null;

  let url = null;
  try {
    url = new URL(input, window.location.origin);
  } catch {
    return null;
  }

  let owner = "";
  let repo = "";
  let kind = "";
  let format = "";
  const params = url.searchParams;
  const ownerRaw = params.get("owner");
  const repoRaw = params.get("repo");
  if (ownerRaw && repoRaw) {
    owner = ownerRaw.trim();
    repo = repoRaw.trim().replace(/\.git$/i, "");
    kind = String(params.get("kind") || "repo").trim().toLowerCase();
    format = String(params.get("format") || "svg").trim().toLowerCase();
  } else {
    const statsMatch = url.pathname.match(/^\/api\/stats\/(repo|quality)\/([^/]+)\/([^/.]+)\.(svg|json)$/i);
    if (!statsMatch) return null;
    kind = statsMatch[1].toLowerCase();
    owner = decodeURIComponent(statsMatch[2]);
    repo = decodeURIComponent(statsMatch[3]).replace(/\.git$/i, "");
    format = statsMatch[4].toLowerCase();
  }

  if (!owner || !repo) return null;
  kind = kind === "quality" ? "quality" : "repo";
  format = format === "json" ? "json" : "svg";

  const parsed = {
    owner,
    repo,
    kind,
    format,
    theme: params.get("theme"),
    locale: params.get("locale"),
    title: params.get("title"),
    hide: params.get("hide"),
    width: params.get("card_width"),
    langs: params.get("langs_count"),
    animate: params.get("animate"),
    animation: params.get("animation"),
    duration: params.get("duration"),
    cacheSeconds: params.get("cache_seconds"),
    includeReport: params.get("include_report"),
    colors: {},
  };

  CUSTOM_THEME_KEYS.forEach((key) => {
    const color = normalizeHexColor(params.get(key) || "");
    if (color) parsed.colors[key] = color;
  });
  return parsed;
}

function parseImportValue(value) {
  const apiImport = parseApiImport(value);
  if (apiImport) return apiImport;

  const input = extractImportUrl(value);
  if (!input) return null;
  const match = REPO_RE.exec(input);
  if (match) return { owner: match[1], repo: match[2] };
  const shortMatch = input.match(/^([^/\s]+)\/([^/\s]+)$/);
  if (shortMatch) {
    return { owner: shortMatch[1], repo: shortMatch[2].replace(/\.git$/i, "") };
  }
  return null;
}

function fillThemes() {
  if (!refs.theme) return;
  const selected = refs.theme.value;
  refs.theme.innerHTML = THEME_IDS.map((theme) => `<option value="${theme}">${themeLabel(theme)}</option>`).join("");
  refs.theme.value = THEME_IDS.includes(selected) ? selected : "ocean";
}

function randomHexColor() {
  const value = Math.floor(Math.random() * 0xffffff);
  return `#${value.toString(16).padStart(6, "0").toUpperCase()}`;
}

function customThemeParams() {
  const result = {};
  CUSTOM_THEME_KEYS.forEach((key) => {
    const node = document.getElementById(`gen-color-${key}`);
    const value = normalizeHexColor(node?.value || "");
    if (value) result[key] = value;
  });
  return result;
}

function applyPalette(palette) {
  CUSTOM_THEME_KEYS.forEach((key) => {
    const node = document.getElementById(`gen-color-${key}`);
    const value = normalizeHexColor(palette?.[key] || "");
    if (node && value) node.value = value;
  });
}

function randomPalette() {
  const palette = {};
  CUSTOM_THEME_KEYS.forEach((key) => {
    palette[key] = randomHexColor();
  });
  return palette;
}

function captureDefaultPalette() {
  if (defaultPalette) return;
  defaultPalette = customThemeParams();
}

function selectedHideFlags() {
  return Array.from(document.querySelectorAll(".gen-hide-option:checked:not(:disabled)"))
    .map((node) => String(node.value || "").trim())
    .filter(Boolean);
}

function syncHideField() {
  if (!refs.hide) return;
  const selected = selectedHideFlags();
  refs.hide.value = selected.join(",");
  if (refs.hideSummary) {
    refs.hideSummary.textContent = selected.length ? selected.join(", ") : t("hideNone");
  }
}

function syncHideOptions() {
  const kind = refs.kind?.value || "repo";
  const format = refs.format?.value || "svg";
  const isSvg = format === "svg";
  Array.from(document.querySelectorAll(".gen-hide-option")).forEach((input) => {
    const allowed = String(input.dataset.kinds || "repo,quality")
      .split(",")
      .map((item) => item.trim())
      .filter(Boolean);
    const supported = isSvg && allowed.includes(kind);
    input.disabled = !supported;
    if (!supported) input.checked = false;
    input.closest(".multi-select-option")?.classList.toggle("is-disabled", !supported);
  });
  if (refs.hidePanel) {
    refs.hidePanel.classList.toggle("is-disabled", !isSvg);
    if (!isSvg) refs.hidePanel.removeAttribute("open");
  }
  syncHideField();
}

function syncControlVisibility() {
  const isSvg = (refs.format?.value || "svg") === "svg";
  const isRepo = (refs.kind?.value || "repo") === "repo";
  const isQualityJson = !isSvg && !isRepo;

  refs.svgControls?.classList.toggle("hidden", !isSvg);
  refs.repoLangsGroup?.classList.toggle("hidden", !isRepo);
  refs.qualityJsonControls?.classList.toggle("hidden", !isQualityJson);

  SVG_ONLY_CONTROL_IDS.forEach((id) => {
    const node = document.getElementById(id);
    if (node) node.disabled = !isSvg;
  });
  if (refs.themeRandom) {
    refs.themeRandom.disabled = !isSvg;
    refs.themeRandom.classList.toggle("is-disabled", !isSvg);
  }
  if (refs.includeReport) refs.includeReport.disabled = !isQualityJson;
  if (refs.langs) refs.langs.disabled = !isRepo;
}

function syncCustomThemePanelVisibility() {
  const show = (refs.theme?.value || "ocean") === "custom" && (refs.format?.value || "svg") === "svg";
  refs.customPanel?.classList.toggle("hidden", !show);
  CUSTOM_THEME_KEYS.forEach((key) => {
    const node = document.getElementById(`gen-color-${key}`);
    if (node) node.disabled = !show;
  });
  ["gen-theme-preset", "gen-apply-preset", "gen-randomize-palette", "gen-reset-palette"].forEach((id) => {
    const node = document.getElementById(id);
    if (!node) return;
    node.disabled = !show;
    node.classList.toggle("is-disabled", !show);
  });
}

function setOpenLinkState(disabled) {
  if (!refs.openUrl) return;
  refs.openUrl.classList.toggle("is-disabled", disabled);
  if (disabled) {
    refs.openUrl.setAttribute("aria-disabled", "true");
    refs.openUrl.setAttribute("tabindex", "-1");
    refs.openUrl.href = "#";
    return;
  }
  refs.openUrl.removeAttribute("aria-disabled");
  refs.openUrl.removeAttribute("tabindex");
}

function setActionButtonState(node, disabled) {
  if (!node) return;
  node.disabled = disabled;
  node.classList.toggle("is-disabled", disabled);
}

async function copyToClipboard(text) {
  const value = String(text || "");
  if (!value) return false;
  try {
    if (navigator.clipboard && window.isSecureContext) {
      await navigator.clipboard.writeText(value);
      return true;
    }
  } catch {
    // Fallback below.
  }
  try {
    const area = document.createElement("textarea");
    area.value = value;
    area.setAttribute("readonly", "true");
    area.style.position = "fixed";
    area.style.left = "-9999px";
    document.body.appendChild(area);
    area.focus();
    area.select();
    const ok = document.execCommand("copy");
    document.body.removeChild(area);
    return ok;
  } catch {
    return false;
  }
}

function buildApiUrl() {
  if (!API_BASE || !refs.owner?.value.trim() || !refs.repo?.value.trim()) return "";
  const format = refs.format?.value || "svg";
  const kind = refs.kind?.value || "repo";
  const params = new URLSearchParams();
  params.set("owner", refs.owner.value.trim());
  params.set("repo", refs.repo.value.trim());
  params.set("kind", kind);
  params.set("format", format);

  if (format === "svg") {
    params.set("theme", refs.theme?.value || "ocean");
    params.set("locale", refs.locale?.value || "en");
    params.set("card_width", String(Math.max(640, Math.min(1400, Number(refs.width?.value || 760)))));
    params.set("animate", refs.animate?.checked ? "true" : "false");
    params.set("animation", refs.animation?.value || "all");
    params.set("duration", String(Math.max(350, Math.min(7000, Number(refs.duration?.value || 1400)))));
    params.set("cache_seconds", String(Math.max(0, Math.min(86400, Number(refs.cacheSeconds?.value || 21600)))));
    if (kind === "repo") {
      params.set("langs_count", String(Math.max(1, Math.min(10, Number(refs.langs?.value || 4)))));
    }
    const title = refs.title?.value.trim() || "";
    const hide = refs.hide?.value.trim() || "";
    if (title) params.set("title", title);
    if (hide) params.set("hide", hide);
    if ((refs.theme?.value || "ocean") === "custom") {
      Object.entries(customThemeParams()).forEach(([key, value]) => params.set(key, value));
    }
  } else if (kind === "repo") {
    params.set("langs_count", String(Math.max(1, Math.min(30, Number(refs.langs?.value || 4)))));
  } else {
    params.set("locale", refs.locale?.value || "en");
    if (refs.includeReport?.checked) params.set("include_report", "true");
  }

  return `${API_BASE}/api?${params.toString()}`;
}

async function refreshPreview() {
  refs.apiWarning?.classList.add("hidden");
  if (refs.apiWarning) refs.apiWarning.textContent = "";
  const url = buildApiUrl();
  if (refs.url) refs.url.value = url;
  if (refs.openUrl) refs.openUrl.href = url || "#";

  if (!API_BASE) {
    refs.apiWarning?.classList.remove("hidden");
    if (refs.apiWarning) refs.apiWarning.textContent = t("apiMissing");
    refs.img?.removeAttribute("src");
    if (refs.json) refs.json.textContent = "";
    refs.imgWrap?.classList.remove("hidden");
    refs.json?.classList.add("hidden");
    if (refs.md) refs.md.value = "";
    setOpenLinkState(true);
    setActionButtonState(refs.copyUrl, true);
    setActionButtonState(refs.copyMd, true);
    return;
  }

  if (!url) {
    refs.img?.removeAttribute("src");
    if (refs.json) refs.json.textContent = "";
    refs.imgWrap?.classList.remove("hidden");
    refs.json?.classList.add("hidden");
    if (refs.md) refs.md.value = "";
    setOpenLinkState(true);
    setActionButtonState(refs.copyUrl, true);
    setActionButtonState(refs.copyMd, true);
    return;
  }

  setOpenLinkState(false);
  setActionButtonState(refs.copyUrl, false);

  if ((refs.format?.value || "svg") === "svg") {
    if (refs.md) refs.md.value = `![Repo Inspector Card](${url})`;
    refs.imgWrap?.classList.remove("hidden");
    refs.json?.classList.add("hidden");
    if (refs.img) refs.img.src = url;
    setActionButtonState(refs.copyMd, false);
    return;
  }

  if (refs.md) refs.md.value = "";
  setActionButtonState(refs.copyMd, true);
  refs.imgWrap?.classList.add("hidden");
  refs.json?.classList.remove("hidden");
  try {
    const response = await fetch(url);
    const payload = await response.json();
    if (refs.json) refs.json.textContent = JSON.stringify(payload, null, 2);
  } catch {
    if (refs.json) refs.json.textContent = t("failedJson");
  }
}

function applyI18n() {
  document.title = t("pageTitle");
  document.documentElement.lang = lang;
  refs.body.dataset.lang = lang;
  document.getElementById("gen-kicker").textContent = t("kicker");
  document.getElementById("gen-title-heading").textContent = t("title");
  document.getElementById("gen-subtitle").textContent = t("subtitle");
  document.getElementById("gen-back").textContent = t("back");
  document.getElementById("gen-config-title").textContent = t("config");
  document.getElementById("gen-import-label").textContent = t("importLabel");
  refs.importBtn.textContent = t("importBtn");
  if (refs.repoUrl) refs.repoUrl.placeholder = t("importPlaceholder");
  document.getElementById("gen-owner-label").textContent = t("owner");
  document.getElementById("gen-repo-label").textContent = t("repo");
  document.getElementById("gen-kind-label").textContent = t("cardType");
  refs.kind.options[0].text = t("cardRepo");
  refs.kind.options[1].text = t("cardQuality");
  document.getElementById("gen-format-label").textContent = t("format");
  document.getElementById("gen-theme-label").textContent = t("theme");
  document.getElementById("gen-locale-label").textContent = t("locale");
  document.getElementById("gen-title-label").textContent = t("customTitle");
  refs.title.placeholder = t("optionalTitle");
  document.getElementById("gen-hide-label").textContent = t("hide");
  document.getElementById("gen-width-label").textContent = t("width");
  document.getElementById("gen-langs-label").textContent = t("langs");
  document.getElementById("gen-animate-label").textContent = t("animate");
  document.getElementById("gen-animation-label").textContent = t("animation");
  document.getElementById("gen-duration-label").textContent = t("duration");
  document.getElementById("gen-cache-label").textContent = t("cache");
  document.getElementById("gen-include-report-label").textContent = t("includeReport");
  document.getElementById("gen-preview-title").textContent = t("preview");
  refs.copyUrl.textContent = t("copyUrl");
  refs.copyMd.textContent = t("copyMd");
  refs.openUrl.textContent = t("openUrl");
  document.getElementById("gen-url-label").textContent = t("generatedUrl");
  document.getElementById("gen-md-label").textContent = t("markdown");
  document.getElementById("gen-custom-theme-title").textContent = t("customThemeTitle");
  document.getElementById("gen-custom-theme-hint").textContent = t("customThemeHint");
  document.getElementById("gen-theme-random").textContent = t("randomTheme");
  document.getElementById("gen-theme-preset-label").textContent = t("palettePreset");
  refs.applyPreset.textContent = t("applyPreset");
  refs.randomizePalette.textContent = t("randomizePalette");
  refs.resetPalette.textContent = t("resetPalette");
  refs.hideSelectAll.textContent = t("hideSelectAll");
  refs.hideClear.textContent = t("hideClear");
  document.getElementById("gen-hide-option-description").textContent = t("hide_description");
  document.getElementById("gen-hide-option-languages").textContent = t("hide_languages");
  document.getElementById("gen-hide-option-meta").textContent = t("hide_meta");
  document.getElementById("gen-hide-option-stars").textContent = t("hide_stars");
  document.getElementById("gen-hide-option-forks").textContent = t("hide_forks");
  document.getElementById("gen-hide-option-issues").textContent = t("hide_issues");
  document.getElementById("gen-hide-option-watchers").textContent = t("hide_watchers");
  document.getElementById("gen-hide-option-status").textContent = t("hide_status");
  document.getElementById("gen-hide-option-lines").textContent = t("hide_lines");
  document.getElementById("gen-hide-option-stacks").textContent = t("hide_stacks");
  document.getElementById("gen-hide-option-commit").textContent = t("hide_commit");
  document.getElementById("gen-hide-option-categories").textContent = t("hide_categories");
  document.getElementById("gen-hide-option-ring").textContent = t("hide_ring");
  document.getElementById("gen-hide-option-footer").textContent = t("hide_footer");
  refs.themePreset.options[0].text = t("presetOcean");
  refs.themePreset.options[1].text = t("presetEmber");
  refs.themePreset.options[2].text = t("presetNeon");
  refs.themePreset.options[3].text = t("presetPaper");
  refs.themePreset.options[4].text = t("presetForest");

  CUSTOM_THEME_KEYS.forEach((key) => {
    const label = document.getElementById(`gen-color-label-${key}`);
    if (label) label.textContent = t(`color_${key}`) || key;
  });

  refs.langSwitch.classList.toggle("lang-ru", lang === "ru");
  refs.langSwitch.classList.toggle("lang-en", lang === "en");
  refs.langSwitch.querySelectorAll(".link").forEach((node) => {
    node.classList.toggle("active", node.dataset.lang === lang);
  });
  fillThemes();
}

function pickRandomTheme() {
  if (!refs.theme) return;
  const values = Array.from(refs.theme.options)
    .map((item) => item.value)
    .filter((value) => value !== "custom");
  if (!values.length) return;
  refs.theme.value = values[Math.floor(Math.random() * values.length)];
}

function setHideSelection(checked) {
  document.querySelectorAll(".gen-hide-option:not(:disabled)").forEach((node) => {
    node.checked = checked;
  });
  syncHideField();
}

function applyHideFlags(rawValue) {
  const selected = new Set(
    String(rawValue || "")
      .split(",")
      .map((item) => item.trim().toLowerCase())
      .filter(Boolean)
  );
  document.querySelectorAll(".gen-hide-option").forEach((node) => {
    if (node.disabled) {
      node.checked = false;
      return;
    }
    node.checked = selected.has(String(node.value || "").trim().toLowerCase());
  });
  syncHideField();
}

function applyImportToForm(parsed) {
  if (parsed.owner) refs.owner.value = parsed.owner;
  if (parsed.repo) refs.repo.value = parsed.repo;
  if (parsed.kind) refs.kind.value = parsed.kind === "quality" ? "quality" : "repo";
  if (parsed.format) refs.format.value = parsed.format === "json" ? "json" : "svg";

  syncControlVisibility();
  syncHideOptions();

  if (parsed.theme) {
    const theme = String(parsed.theme).trim().toLowerCase();
    if (Array.from(refs.theme.options).some((node) => node.value === theme)) refs.theme.value = theme;
  }
  if (parsed.locale) {
    const locale = String(parsed.locale).trim().toLowerCase();
    if (locale === "en" || locale === "ru") refs.locale.value = locale;
  }
  refs.title.value = parsed.title ?? "";
  if (parsed.width != null) refs.width.value = String(clampNumber(parsed.width, 640, 1400, 760));
  if (parsed.langs != null) refs.langs.value = String(clampNumber(parsed.langs, 1, 30, 4));
  if (parsed.animate != null) refs.animate.checked = parseBooleanValue(parsed.animate, true);
  if (parsed.animation) {
    const mode = String(parsed.animation).trim().toLowerCase();
    if (["all", "soft", "bars", "ring", "none"].includes(mode)) refs.animation.value = mode;
  }
  if (parsed.duration != null) refs.duration.value = String(clampNumber(parsed.duration, 350, 7000, 1400));
  if (parsed.cacheSeconds != null) refs.cacheSeconds.value = String(clampNumber(parsed.cacheSeconds, 0, 86400, 21600));
  refs.includeReport.checked = parseBooleanValue(parsed.includeReport, false);
  applyHideFlags(parsed.hide ?? "");

  if (parsed.colors && typeof parsed.colors === "object") {
    applyPalette(parsed.colors);
  }
  syncCustomThemePanelVisibility();
}

function bindEvents() {
  const controls = [
    refs.owner,
    refs.repo,
    refs.kind,
    refs.format,
    refs.theme,
    refs.locale,
    refs.title,
    refs.hide,
    refs.width,
    refs.langs,
    refs.animate,
    refs.animation,
    refs.duration,
    refs.cacheSeconds,
    refs.includeReport,
    refs.themePreset,
  ];
  controls.forEach((node) => {
    if (!node) return;
    node.addEventListener("input", () => void refreshPreview());
    node.addEventListener("change", () => void refreshPreview());
  });

  CUSTOM_THEME_KEYS.forEach((key) => {
    const node = document.getElementById(`gen-color-${key}`);
    if (!node) return;
    node.addEventListener("input", () => void refreshPreview());
    node.addEventListener("change", () => void refreshPreview());
  });

  refs.theme?.addEventListener("change", () => {
    syncControlVisibility();
    syncHideOptions();
    syncCustomThemePanelVisibility();
    void refreshPreview();
  });
  refs.format?.addEventListener("change", () => {
    syncControlVisibility();
    syncHideOptions();
    syncCustomThemePanelVisibility();
    void refreshPreview();
  });
  refs.kind?.addEventListener("change", () => {
    syncControlVisibility();
    syncHideOptions();
    void refreshPreview();
  });

  document.querySelectorAll(".gen-hide-option").forEach((node) => {
    node.addEventListener("change", () => {
      syncHideField();
      void refreshPreview();
    });
  });
  refs.hideSelectAll?.addEventListener("click", () => {
    setHideSelection(true);
    void refreshPreview();
  });
  refs.hideClear?.addEventListener("click", () => {
    setHideSelection(false);
    void refreshPreview();
  });
  refs.themeRandom?.addEventListener("click", () => {
    pickRandomTheme();
    syncCustomThemePanelVisibility();
    void refreshPreview();
  });
  refs.applyPreset?.addEventListener("click", () => {
    const presetId = refs.themePreset.value in THEME_PRESETS ? refs.themePreset.value : "ocean";
    applyPalette(THEME_PRESETS[presetId]);
    void refreshPreview();
  });
  refs.randomizePalette?.addEventListener("click", () => {
    applyPalette(randomPalette());
    void refreshPreview();
  });
  refs.resetPalette?.addEventListener("click", () => {
    captureDefaultPalette();
    applyPalette(defaultPalette || THEME_PRESETS.ocean);
    void refreshPreview();
  });
  ["gen-theme-random", "gen-apply-preset", "gen-randomize-palette", "gen-reset-palette"].forEach((id) => {
    document.getElementById(id)?.addEventListener("click", (event) => {
      event.preventDefault();
    });
  });

  refs.importBtn?.addEventListener("click", () => {
    const parsed = parseImportValue(refs.repoUrl.value);
    if (!parsed) {
      refs.importError.textContent = t("invalidRepoUrl");
      return;
    }
    applyImportToForm(parsed);
    refs.importError.textContent = "";
    void refreshPreview();
  });
  refs.repoUrl?.addEventListener("keydown", (event) => {
    if (event.key !== "Enter") return;
    event.preventDefault();
    refs.importBtn.click();
  });
  refs.repoUrl?.addEventListener("input", () => {
    refs.importError.textContent = "";
  });

  refs.copyUrl?.addEventListener("click", async () => {
    if (!refs.url.value) return;
    const copied = await copyToClipboard(refs.url.value);
    if (!copied) return;
    const prev = refs.copyUrl.textContent;
    refs.copyUrl.textContent = t("copied");
    window.setTimeout(() => {
      refs.copyUrl.textContent = prev;
    }, 900);
  });

  refs.copyMd?.addEventListener("click", async () => {
    if (!refs.md.value) return;
    const copied = await copyToClipboard(refs.md.value);
    if (!copied) return;
    const prev = refs.copyMd.textContent;
    refs.copyMd.textContent = t("copied");
    window.setTimeout(() => {
      refs.copyMd.textContent = prev;
    }, 900);
  });

  document.addEventListener("click", (event) => {
    if (!refs.hidePanel) return;
    if (!refs.hidePanel.contains(event.target)) refs.hidePanel.removeAttribute("open");
  });

  refs.langSwitch?.querySelectorAll(".link").forEach((node) => {
    node.addEventListener("click", (event) => {
      event.preventDefault();
      const prevLang = lang;
      lang = node.dataset.lang || "en";
      if (!refs.locale.value || refs.locale.value === prevLang) refs.locale.value = lang;
      applyI18n();
      syncControlVisibility();
      syncHideOptions();
      syncCustomThemePanelVisibility();
      void refreshPreview();
    });
  });
}

fillThemes();
if (refs.locale) refs.locale.value = lang;
captureDefaultPalette();
applyI18n();
syncControlVisibility();
syncHideOptions();
syncCustomThemePanelVisibility();
bindEvents();
void refreshPreview();
