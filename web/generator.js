const I18N = {
  en: {
    pageTitle: "Repo Inspector - Generator",
    kicker: "EMBEDDABLE STATS",
    title: "SVG/JSON generator",
    subtitle: "Build URL parameters visually, preview card, and copy URL/Markdown.",
    back: "Back to reports",
    config: "Configuration",
    importLabel: "Import by GitHub URL",
    importBtn: "Import",
    owner: "Owner",
    repo: "Repository",
    cardType: "Card type",
    cardRepo: "Repository stats",
    cardQuality: "Quality stats",
    format: "Format",
    theme: "Theme",
    locale: "Locale",
    customTitle: "Custom title",
    optionalTitle: "Optional title",
    hide: "Hide flags (comma-separated)",
    width: "Card width",
    langs: "Languages count (repo card)",
    animate: "Enable animation",
    animation: "Animation mode",
    duration: "Animation duration (ms)",
    preview: "Preview",
    copyUrl: "Copy URL",
    copyMd: "Copy Markdown",
    openUrl: "Open URL",
    generatedUrl: "Generated URL",
    markdown: "Markdown embed",
    invalidRepoUrl: "Enter a valid GitHub URL like https://github.com/owner/repo",
    copied: "Copied",
    apiMissing: "Set API_BASE in web/config.js to use generator preview on GitHub Pages.",
    failedJson: "Failed to load JSON",
  },
  ru: {
    pageTitle: "Repo Inspector - Р“РµРЅРµСЂР°С‚РѕСЂ",
    kicker: "\u0412\u0421\u0422\u0420\u0410\u0418\u0412\u0410\u0415\u041c\u0410\u042f \u0421\u0422\u0410\u0422\u0418\u0421\u0422\u0418\u041a\u0410",
    title: "SVG/JSON РіРµРЅРµСЂР°С‚РѕСЂ",
    subtitle: "\u0421\u043e\u0431\u0438\u0440\u0430\u0439\u0442\u0435 URL-\u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b, \u0441\u043c\u043e\u0442\u0440\u0438\u0442\u0435 \u043f\u0440\u0435\u0432\u044c\u044e \u0438 \u043a\u043e\u043f\u0438\u0440\u0443\u0439\u0442\u0435 URL/Markdown.",
    back: "\u041d\u0430\u0437\u0430\u0434 \u043a \u043e\u0442\u0447\u0435\u0442\u0430\u043c",
    config: "\u041a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u044f",
    importLabel: "\u0418\u043c\u043f\u043e\u0440\u0442 \u043f\u043e \u0441\u0441\u044b\u043b\u043a\u0435 GitHub",
    importBtn: "\u0418\u043c\u043f\u043e\u0440\u0442\u0438\u0440\u043e\u0432\u0430\u0442\u044c",
    owner: "\u0412\u043b\u0430\u0434\u0435\u043b\u0435\u0446",
    repo: "\u0420\u0435\u043f\u043e\u0437\u0438\u0442\u043e\u0440\u0438\u0439",
    cardType: "\u0422\u0438\u043f \u043a\u0430\u0440\u0442\u043e\u0447\u043a\u0438",
    cardRepo: "\u0421\u0442\u0430\u0442\u0438\u0441\u0442\u0438\u043a\u0430 \u0440\u0435\u043f\u043e\u0437\u0438\u0442\u043e\u0440\u0438\u044f",
    cardQuality: "\u0421\u0442\u0430\u0442\u0438\u0441\u0442\u0438\u043a\u0430 quality",
    format: "\u0424\u043e\u0440\u043c\u0430\u0442",
    theme: "\u0422\u0435\u043c\u0430",
    locale: "\u042f\u0437\u044b\u043a",
    customTitle: "\u0421\u0432\u043e\u0439 \u0437\u0430\u0433\u043e\u043b\u043e\u0432\u043e\u043a",
    optionalTitle: "\u041d\u0435\u043e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u043e",
    hide: "\u0421\u043a\u0440\u044b\u0442\u044c \u0431\u043b\u043e\u043a\u0438 (\u0447\u0435\u0440\u0435\u0437 \u0437\u0430\u043f\u044f\u0442\u0443\u044e)",
    width: "\u0428\u0438\u0440\u0438\u043d\u0430 \u043a\u0430\u0440\u0442\u043e\u0447\u043a\u0438",
    langs: "\u041a\u043e\u043b-\u0432\u043e \u044f\u0437\u044b\u043a\u043e\u0432 (repo \u043a\u0430\u0440\u0442\u0430)",
    animate: "\u0412\u043a\u043b\u044e\u0447\u0438\u0442\u044c \u0430\u043d\u0438\u043c\u0430\u0446\u0438\u044e",
    animation: "\u0420\u0435\u0436\u0438\u043c \u0430\u043d\u0438\u043c\u0430\u0446\u0438\u0438",
    duration: "\u0414\u043b\u0438\u0442\u0435\u043b\u044c\u043d\u043e\u0441\u0442\u044c \u0430\u043d\u0438\u043c\u0430\u0446\u0438\u0438 (ms)",
    preview: "\u041f\u0440\u0435\u0432\u044c\u044e",
    copyUrl: "\u041a\u043e\u043f\u0438\u0440\u043e\u0432\u0430\u0442\u044c URL",
    copyMd: "\u041a\u043e\u043f\u0438\u0440\u043e\u0432\u0430\u0442\u044c Markdown",
    openUrl: "\u041e\u0442\u043a\u0440\u044b\u0442\u044c URL",
    generatedUrl: "\u0421\u0433\u0435\u043d\u0435\u0440\u0438\u0440\u043e\u0432\u0430\u043d\u043d\u044b\u0439 URL",
    markdown: "Markdown \u0434\u043b\u044f \u0432\u0441\u0442\u0430\u0432\u043a\u0438",
    invalidRepoUrl: "\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043a\u043e\u0440\u0440\u0435\u043a\u0442\u043d\u0443\u044e \u0441\u0441\u044b\u043b\u043a\u0443 \u0432\u0438\u0434\u0430 https://github.com/owner/repo",
    copied: "\u0421\u043a\u043e\u043f\u0438\u0440\u043e\u0432\u0430\u043d\u043e",
    apiMissing: "\u0423\u043a\u0430\u0436\u0438\u0442\u0435 API_BASE \u0432 web/config.js \u0434\u043b\u044f preview \u043d\u0430 GitHub Pages.",
    failedJson: "\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044c JSON",
  },
};

const THEMES = [
  "ocean", "light", "midnight", "nord", "forest", "sunset", "lavender",
  "graphite", "mint", "amber", "rose", "slate", "sand", "aurora", "matrix", "mono",
];

const REPO_RE = /^https?:\/\/github\.com\/([^/\s]+)\/([^/\s#]+?)(?:\.git)?\/?$/;
let lang = "en";

const refs = {
  body: document.body,
  langSwitch: document.getElementById("gen-lang-switch"),
  repoUrl: document.getElementById("gen-repo-url"),
  importBtn: document.getElementById("gen-import-repo"),
  importError: document.getElementById("gen-import-error"),
  owner: document.getElementById("gen-owner"),
  repo: document.getElementById("gen-repo"),
  kind: document.getElementById("gen-kind"),
  format: document.getElementById("gen-format"),
  theme: document.getElementById("gen-theme"),
  locale: document.getElementById("gen-locale"),
  customTitle: document.getElementById("gen-custom-title"),
  hide: document.getElementById("gen-hide"),
  width: document.getElementById("gen-width"),
  langs: document.getElementById("gen-langs"),
  animate: document.getElementById("gen-animate"),
  animation: document.getElementById("gen-animation"),
  duration: document.getElementById("gen-duration"),
  copyUrl: document.getElementById("gen-copy-url"),
  copyMd: document.getElementById("gen-copy-md"),
  openUrl: document.getElementById("gen-open-url"),
  url: document.getElementById("gen-url"),
  md: document.getElementById("gen-md"),
  imgWrap: document.getElementById("gen-svg-wrap"),
  img: document.getElementById("gen-preview-image"),
  json: document.getElementById("gen-preview-json"),
  apiWarning: document.getElementById("gen-api-warning"),
};

function t(key) {
  return (I18N[lang] && I18N[lang][key]) || I18N.en[key] || key;
}

function normalizeApiBase(raw) {
  const value = String(raw || "").trim();
  if (!value) return "";
  return value.replace(/\/$/, "");
}

function getApiBase() {
  const cfg = window.REPO_INSPECTOR_CONFIG || {};
  const byConfig = normalizeApiBase(cfg.API_BASE);
  if (byConfig) return byConfig;
  const byQuery = normalizeApiBase(new URLSearchParams(window.location.search).get("api_base"));
  if (byQuery) return byQuery;
  return "";
}

const API_BASE = getApiBase();

function escapeHtml(value) {
  return String(value)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function fillThemes() {
  refs.theme.innerHTML = THEMES.map((theme) => `<option value="${theme}">${theme}</option>`).join("");
}

function applyI18n() {
  document.title = t("pageTitle");
  document.getElementById("gen-kicker").textContent = t("kicker");
  document.getElementById("gen-title").textContent = t("title");
  document.getElementById("gen-subtitle").textContent = t("subtitle");
  document.getElementById("gen-back").textContent = t("back");
  document.getElementById("gen-config-title").textContent = t("config");
  document.getElementById("gen-import-label").textContent = t("importLabel");
  refs.importBtn.textContent = t("importBtn");
  document.getElementById("gen-owner-label").textContent = t("owner");
  document.getElementById("gen-repo-label").textContent = t("repo");
  document.getElementById("gen-kind-label").textContent = t("cardType");
  refs.kind.options[0].text = t("cardRepo");
  refs.kind.options[1].text = t("cardQuality");
  document.getElementById("gen-format-label").textContent = t("format");
  document.getElementById("gen-theme-label").textContent = t("theme");
  document.getElementById("gen-locale-label").textContent = t("locale");
  document.getElementById("gen-title-label").textContent = t("customTitle");
  refs.customTitle.placeholder = t("optionalTitle");
  document.getElementById("gen-hide-label").textContent = t("hide");
  document.getElementById("gen-width-label").textContent = t("width");
  document.getElementById("gen-langs-label").textContent = t("langs");
  document.getElementById("gen-animate-label").textContent = t("animate");
  document.getElementById("gen-animation-label").textContent = t("animation");
  document.getElementById("gen-duration-label").textContent = t("duration");
  document.getElementById("gen-preview-title").textContent = t("preview");
  refs.copyUrl.textContent = t("copyUrl");
  refs.copyMd.textContent = t("copyMd");
  refs.openUrl.textContent = t("openUrl");
  document.getElementById("gen-url-label").textContent = t("generatedUrl");
  document.getElementById("gen-md-label").textContent = t("markdown");

  refs.body.dataset.lang = lang;
  refs.langSwitch.classList.toggle("lang-ru", lang === "ru");
  refs.langSwitch.classList.toggle("lang-en", lang === "en");
  refs.langSwitch.querySelectorAll(".link").forEach((node) => {
    node.classList.toggle("active", node.dataset.lang === lang);
  });
}

function parseRepoRef(url) {
  const match = REPO_RE.exec(String(url || "").trim());
  if (!match) return null;
  return { owner: match[1], repo: match[2] };
}

function buildApiUrl() {
  if (!API_BASE || !refs.owner.value.trim() || !refs.repo.value.trim()) return "";
  const params = new URLSearchParams();
  params.set("owner", refs.owner.value.trim());
  params.set("repo", refs.repo.value.trim());
  params.set("kind", refs.kind.value);
  params.set("format", refs.format.value);
  params.set("theme", refs.theme.value);
  params.set("locale", refs.locale.value);
  params.set("card_width", String(Math.max(640, Math.min(1400, Number(refs.width.value || 760)))));
  params.set("animate", refs.animate.checked ? "true" : "false");
  params.set("animation", refs.animation.value);
  params.set("duration", String(Math.max(350, Math.min(7000, Number(refs.duration.value || 1400)))));
  if (refs.kind.value === "repo") {
    params.set("langs_count", String(Math.max(1, Math.min(10, Number(refs.langs.value || 4)))));
  }
  const title = refs.customTitle.value.trim();
  const hide = refs.hide.value.trim();
  if (title) params.set("title", title);
  if (hide) params.set("hide", hide);
  if (refs.format.value === "json" && refs.kind.value === "quality") {
    params.set("include_report", "true");
  }
  return `${API_BASE}/api?${params.toString()}`;
}

async function refreshPreview() {
  refs.apiWarning.classList.add("hidden");
  refs.apiWarning.textContent = "";
  const url = buildApiUrl();
  refs.url.value = url;
  refs.openUrl.href = url || "#";

  if (!API_BASE) {
    refs.apiWarning.classList.remove("hidden");
    refs.apiWarning.textContent = t("apiMissing");
    refs.img.removeAttribute("src");
    refs.json.textContent = "";
    refs.imgWrap.classList.remove("hidden");
    refs.json.classList.add("hidden");
    refs.md.value = "";
    return;
  }

  if (!url) {
    refs.img.removeAttribute("src");
    refs.json.textContent = "";
    refs.imgWrap.classList.remove("hidden");
    refs.json.classList.add("hidden");
    refs.md.value = "";
    return;
  }

  if (refs.format.value === "svg") {
    refs.md.value = `![Repo Inspector Card](${url})`;
    refs.imgWrap.classList.remove("hidden");
    refs.json.classList.add("hidden");
    refs.img.src = `${url}${url.includes("?") ? "&" : "?"}_ts=${Date.now()}`;
    return;
  }

  refs.md.value = "";
  refs.imgWrap.classList.add("hidden");
  refs.json.classList.remove("hidden");
  try {
    const response = await fetch(url);
    const payload = await response.json();
    refs.json.textContent = JSON.stringify(payload, null, 2);
  } catch {
    refs.json.textContent = t("failedJson");
  }
}

function bindEvents() {
  const controls = [
    refs.owner, refs.repo, refs.kind, refs.format, refs.theme, refs.locale, refs.customTitle, refs.hide,
    refs.width, refs.langs, refs.animate, refs.animation, refs.duration,
  ];
  controls.forEach((node) => {
    node.addEventListener("input", () => void refreshPreview());
    node.addEventListener("change", () => void refreshPreview());
  });

  refs.importBtn.addEventListener("click", () => {
    const parsed = parseRepoRef(refs.repoUrl.value);
    if (!parsed) {
      refs.importError.textContent = t("invalidRepoUrl");
      return;
    }
    refs.owner.value = parsed.owner;
    refs.repo.value = parsed.repo;
    refs.importError.textContent = "";
    void refreshPreview();
  });

  refs.repoUrl.addEventListener("keydown", (event) => {
    if (event.key !== "Enter") return;
    event.preventDefault();
    refs.importBtn.click();
  });

  refs.copyUrl.addEventListener("click", async () => {
    if (!refs.url.value) return;
    await navigator.clipboard.writeText(refs.url.value);
    const prev = refs.copyUrl.textContent;
    refs.copyUrl.textContent = t("copied");
    window.setTimeout(() => {
      refs.copyUrl.textContent = prev;
    }, 900);
  });

  refs.copyMd.addEventListener("click", async () => {
    if (!refs.md.value) return;
    await navigator.clipboard.writeText(refs.md.value);
    const prev = refs.copyMd.textContent;
    refs.copyMd.textContent = t("copied");
    window.setTimeout(() => {
      refs.copyMd.textContent = prev;
    }, 900);
  });

  refs.langSwitch.querySelectorAll(".link").forEach((node) => {
    node.addEventListener("click", (event) => {
      event.preventDefault();
      lang = node.dataset.lang || "en";
      applyI18n();
      void refreshPreview();
    });
  });
}

fillThemes();
applyI18n();
bindEvents();
void refreshPreview();

