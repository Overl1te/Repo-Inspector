# Repo Inspector

Repo Inspector analyzes GitHub repositories via GitHub API (no clone, no code execution) and produces a score-based report.

## Governance and project docs

- `docs/PROJECT_STRUCTURE.md` - architecture map and deploy checklist
- `CODE_OF_CONDUCT.md` / `CODE_OF_CONDUCT_EN.md`
- `CONTRIBUTING.md` / `CONTRIBUTING_EN.md`
- `SECURITY.md` / `SECURITY_EN.md`
- `TERMS_OF_USE.md` / `TERMS_OF_USE_EN.md`
- `CITATION.cff`

Now project supports:
- multiple ecosystems (Python, JavaScript/TypeScript, Java, C/C++, C# and generic configs)
- bilingual UI/report (`EN` / `RU`)
- stack detection (`python`, `javascript`, `java`, `csharp`, `cpp`, `go`, `rust`, ...)
- governance checks (`CODEOWNERS`, PR/Issue templates, `SECURITY.md`)
- CI stage coverage checks (`lint/test/build/release`)
- dependency hygiene checks (lockfiles + dependabot)
- OSV vulnerability scan for pinned dependencies
- prioritized fix plan in report (impact-based)
- score trend chart for repeated scans of the same repository
- trend by commit SHA with score deltas
- total code lines and code file counts (with extension breakdown)
- PR auto-comment workflow with summary report
- PR diff summary in auto-comment (changed files/additions/deletions/extensions)
- GitHub Check Run integration on PRs
- optional API-key + rate limit for scan endpoint
- daily quota per API key/IP
- cache TTL for repeated scans of the same commit
- report comparison vs previous commit (changed checks + changed files)
- report export in JSON/Markdown/TXT
- health and Prometheus-style metrics endpoints
- repo-level policy via `.repo-inspector.yml`
- policy validation diagnostics in report
- secret scan allowlist via policy (`security.secret_allowlist_*`)
- DB cleanup for repeated scans (dedupe by commit + retention per repo)
- local interactive mode (FastAPI)
- static GitHub Pages mode with reports generated by GitHub Actions

## 1. Modes

### Local interactive mode (recommended for instant scans)
- Start FastAPI locally.
- Enter repository URL in UI.
- Background job runs immediately.

### GitHub Pages mode (static hosting)
- UI is static HTML/CSS/JS in `web/`.
- Reports are generated by workflow `.github/workflows/generate-report.yml`.
- Workflow writes JSON files to `web/reports/`.
- Static page loads those JSON reports.

This is the "GitHub Pages workaround": computation runs in Actions, UI is static.

### Vercel API mode (github-readme-stats style)
- Deploy FastAPI as serverless API on Vercel.
- Use `/api?owner=<owner>&repo=<repo>&kind=repo|quality&format=svg|json`.
- Use GitHub Pages as frontend and call the Vercel API for dynamic cards/data.

## 2. Configuration (`config.yml`)

Project uses only open YAML config:
- `config.yml` in repository root.
- `.env` is not used.

Token is optional:
- without token: works for public repositories, lower rate limit
- with token in `config.yml`: higher API limits

Example `config.yml`:

```yaml
app:
  name: "Repo Inspector"
  logo_path: "/static/logo.png"
  title_separator: "Р’В·"

github:
  token: ""
  app_token: ""
  api_base: "https://api.github.com"

database:
  url: "sqlite:///./data/app.db"

scan:
  rate_limit_per_minute: 25
  daily_quota: 300
  cache_ttl_seconds: 1800
  repo_history_keep: 20
  stale_active_job_minutes: 120
```

## 3. Repository policy config (`.repo-inspector.yml`)

You can put `.repo-inspector.yml` into a repository being scanned.

Example file:

```yaml
checks:
  readme_min_length: 300
  stale_days: 120

scoring:
  category_weights:
    security: 30
    quality: 25

baseline:
  min_score: 75
  max_score_drop: 5

ignore:
  checks:
    - issue_template_exists

security:
  secret_allowlist_paths:
    - docs/examples/*
  secret_allowlist_patterns:
    - AKIA_TEST_
```

Notes:
- if you scan the same commit multiple times, old duplicate scan rows are removed automatically
- report history keeps only the latest `REPO_HISTORY_KEEP` scans per repository
- stale active jobs (`queued/running`) are auto-marked as failed after `STALE_ACTIVE_JOB_MINUTES`

## 4. Quick local start (Windows)

```bat
run.bat
```

`run.bat` will:
1. create `.venv` if missing
2. install dependencies
3. check `config.yml`
4. run `uvicorn`

Then open:
- `http://127.0.0.1:8000`

## 5. Manual local start

### Windows PowerShell

```powershell
python -m venv .venv
.\.venv\Scripts\Activate.ps1
pip install -r requirements.txt
pip install -e .[dev]
uvicorn app.main:app --reload
```

### macOS/Linux

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
pip install -e .[dev]
uvicorn app.main:app --reload
```

## 6. Language switch (EN/RU)

- Local UI: use EN/RU toggle in top-right corner.
- Local API JSON: `GET /api/report/{job_id}.json?lang=ru` (or `en`).
- Pages UI: EN/RU buttons in static page.

## 7. GitHub Pages setup

1. Push repository to GitHub.
2. In repo settings go to `Settings -> Pages` and set `Build and deployment` to `GitHub Actions`.
3. Run workflow `Deploy Pages` once (or push any change into `web/`).
4. Open the Pages URL from `Settings -> Pages`.
5. Configure data source for Pages UI in `web/config.js`:
   - `API_BASE: ""` -> read local files from `web/reports/*.json`
   - `API_BASE: "https://<your-vercel-domain>"` -> call live Vercel API

Static page will load reports from:
- `web/reports/<owner>__<repo>.en.json`
- `web/reports/<owner>__<repo>.ru.json`

## 8. Generate report via GitHub Actions

1. Open Actions tab.
2. Run workflow `Generate Report`.
3. Pass:
   - `repo_url`: `https://github.com/<owner>/<repo>`
   - `lang`: `en` or `ru`
4. Workflow commits generated JSON into `web/reports/`.
5. Refresh GitHub Pages UI and load report.

Actions use only repository files and default GitHub permissions.

## 9. PR auto-comment workflow

Workflow:
- `.github/workflows/pr-quality-comment.yml`

On every PR update it:
1. scans repository quality
2. builds markdown summary + PR diff summary
3. creates/updates one sticky PR comment
4. creates a GitHub Check Run (`Repo Inspector`) with score-based status

Permissions used:
- `pull-requests: write`
- `contents: read`
- `checks: write`

## 10. Generate report locally (without FastAPI)

```bash
python scripts/generate_report.py --repo-url "https://github.com/owner/repo" --lang en
python scripts/generate_report.py --repo-url "https://github.com/owner/repo" --lang ru
```

Output files:
- `web/reports/owner__repo.en.json`
- `web/reports/owner__repo.ru.json`

## 11. API examples (local FastAPI mode)

Start scan:

```bash
curl -X POST http://127.0.0.1:8000/api/scan \
  -H "Content-Type: application/json" \
  -d "{\"repo_url\":\"https://github.com/tiangolo/fastapi\"}"
```

For private repositories, pass one-time token in request body:

```bash
curl -X POST http://127.0.0.1:8000/api/scan \
  -H "Content-Type: application/json" \
  -d "{\"repo_url\":\"https://github.com/owner/private-repo\",\"github_token\":\"ghp_xxx\"}"
```

Token is used only for this scan and is not stored in database or files.

Job status:

```bash
curl "http://127.0.0.1:8000/api/jobs/<job_id>?lang=ru"
```

Report JSON:

```bash
curl "http://127.0.0.1:8000/api/report/<job_id>.json?lang=en"
```

Report Markdown:

```bash
curl "http://127.0.0.1:8000/api/report/<job_id>.md?lang=en"
```

Report TXT:

```bash
curl "http://127.0.0.1:8000/api/report/<job_id>.txt?lang=en"
```

Repository score history:

```bash
curl "http://127.0.0.1:8000/api/repos/<owner>/<repo>/history"
```

Latest report for repository:

```bash
curl "http://127.0.0.1:8000/api/repos/<owner>/<repo>/latest"
```

Repository public stats JSON:

```bash
curl "http://127.0.0.1:8000/api/stats/repo/<owner>/<repo>.json?langs_count=8"
```

Repository public stats SVG card (embeddable):

```bash
curl "http://127.0.0.1:8000/api/stats/repo/<owner>/<repo>.svg?theme=ocean&locale=ru&langs_count=5&animate=true&animation=all&duration=1600"
```

Quality stats JSON:

```bash
curl "http://127.0.0.1:8000/api/stats/quality/<owner>/<repo>.json"
```

Quality score SVG card:

```bash
curl "http://127.0.0.1:8000/api/stats/quality/<owner>/<repo>.svg?theme=midnight&hide=commit,footer&animate=true&animation=ring"
```

SVG generator page (with dynamic preview):

```bash
http://127.0.0.1:8000/generator
```

Supported SVG params:
- `theme`: `ocean|light|midnight`
- `locale`: `en|ru`
- `hide`: comma separated flags
- `title`: custom title
- `card_width`: `640..1400`
- `animate`: `true|false`
- `animation`: `all|soft|bars|ring|none`
- `duration`: `350..7000` (ms)
- `langs_count`: `1..10` (repo card only)

Legacy combined stats (backward-compatible):

```bash
curl "http://127.0.0.1:8000/api/stats/<owner>/<repo>.json"
```

Compare two reports:

```bash
curl "http://127.0.0.1:8000/api/compare/<job_id>/<previous_job_id>"
```

Health / metrics:

```bash
curl "http://127.0.0.1:8000/health"
curl "http://127.0.0.1:8000/metrics"
```

## 12. Dev checks

```bash
ruff check .
pytest -q
```

## 13. Vercel (API only) + GitHub Pages (UI)

1. Import repository into Vercel.
2. Keep project root as-is (uses `vercel.json` + `api/index.py`).
3. Optionally set env vars in Vercel:
   - `RQI_GITHUB_TOKEN` (recommended for higher GitHub API limits)
   - `RQI_DATABASE_URL` (default on Vercel is `sqlite:////tmp/repo_inspector.db`)
4. Deploy and test API endpoints:
   - `https://<your-vercel-domain>/health`
   - `https://<your-vercel-domain>/api?owner=Overl1te&repo=CyberDeck&kind=repo`
   - `https://<your-vercel-domain>/api?owner=Overl1te&repo=CyberDeck&kind=quality`
   - `https://<your-vercel-domain>/api?owner=Overl1te&repo=CyberDeck&kind=quality&format=json&include_report=true`
5. Set `API_BASE` in `web/config.js` to your Vercel domain and redeploy Pages.

Recommended architecture:
- GitHub Pages: UI/visualization layer
- Vercel: API/SVG/JSON generation layer

## 14. How to use (production)

1. Open your GitHub Pages URL.
2. Paste repository URL (for example `https://github.com/Overl1te/CyberDeck`).
3. Click `Load report`.
4. UI requests live data from Vercel API (`/api?...`) if `API_BASE` is configured.
5. If `API_BASE` is empty, UI falls back to static reports in `web/reports`.

Quick embed examples (README badges/cards):

```md
![Repo stats](https://<your-vercel-domain>/api?owner=Overl1te&repo=CyberDeck&kind=repo&theme=ocean&animate=true)
![Quality score](https://<your-vercel-domain>/api?owner=Overl1te&repo=CyberDeck&kind=quality&theme=midnight&animate=true)
```

